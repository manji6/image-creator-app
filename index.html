<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Batch Studio</title>
    <meta
      name="description"
      content="ローカルファーストで複数プロンプトの画像を一括生成できるWebアプリ"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Space+Grotesk:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              heading: ['"Space Grotesk"', 'sans-serif'],
              body: ['"Manrope"', 'sans-serif']
            },
            boxShadow: {
              card: '0 20px 40px rgba(18, 35, 66, 0.12)',
              soft: '0 6px 22px rgba(10, 30, 60, 0.08)'
            },
            colors: {
              slateBrand: '#133051',
              sea: '#0f766e',
              coral: '#e76f51',
              mist: '#f2f7ff'
            }
          }
        }
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./styles.css?v=20260211e" />
  </head>
  <body class="font-body text-slate-800">
    <div class="page-bg"></div>
    <main class="relative mx-auto flex min-h-screen w-full max-w-[1360px] flex-col gap-6 p-4 md:p-8">
      <header class="rounded-3xl border border-white/60 bg-white/80 p-6 shadow-card backdrop-blur-md">
        <nav class="mb-4 flex flex-wrap items-center gap-4 border-b border-slate-200 pb-4">
          <a href="./index.html" class="text-sm font-semibold text-sea transition hover:text-sea/80">
            アプリ
          </a>
          <a href="./help.html" class="text-sm font-semibold text-slate-600 transition hover:text-sea">
            使い方
          </a>
          <a href="./guide/firefly-token.html" class="text-sm font-semibold text-slate-600 transition hover:text-sea">
            Fireflyガイド
          </a>
        </nav>
        <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
          <div>
            <p class="text-sm font-semibold uppercase tracking-[0.2em] text-sea">Local-First Image Ops</p>
            <h1 class="font-heading text-3xl font-bold text-slateBrand">Image Batch Studio</h1>
            <p class="mt-2 text-sm text-slate-600">
              簡単に画像生成APIを実行するWebアプリです。API接続情報はあなたのブラウザ上に保存されており、Webアプリ側で一切保存していません。
            </p>
          </div>
          <div class="grid gap-3 sm:grid-cols-2">
            <button
              id="saveSettingsButton"
              class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-soft transition hover:border-sea hover:text-sea"
              type="button"
            >
              設定を保存
            </button>
            <button
              id="clearCardsButton"
              class="rounded-xl border border-coral/40 bg-coral/5 px-4 py-2 text-sm font-semibold text-coral transition hover:bg-coral/10"
              type="button"
            >
              カードを全削除
            </button>
          </div>
        </div>
      </header>

      <section class="grid gap-6 xl:grid-cols-[360px_minmax(0,1fr)]">
        <aside class="space-y-6">
          <article class="rounded-3xl border border-white/60 bg-white/85 p-5 shadow-card backdrop-blur-md">
            <h2 class="font-heading text-lg font-bold text-slateBrand">生成設定</h2>
            <p class="mt-1 text-xs text-slate-500">キー未設定のプロバイダは実行できません。</p>

            <label class="mt-4 block text-sm font-semibold text-slate-700" for="providerSelect">利用プロバイダ</label>
            <select id="providerSelect" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:border-sea focus:outline-none">
              <option value="fal">fal.ai</option>
              <option value="google">Google AI Studio</option>
              <option value="firefly">Adobe Firefly</option>
            </select>
            <p id="providerHint" class="mt-2 rounded-lg bg-mist px-3 py-2 text-xs text-slate-600"></p>

            <div class="mt-3 space-y-2 rounded-2xl border border-slate-200 bg-slate-50/70 p-3">
              <div class="flex items-center justify-between gap-2">
                <label class="block text-xs font-semibold text-slate-600" for="providerModelSelect">モデル選択</label>
                <button
                  id="refreshModelsButton"
                  type="button"
                  class="rounded-lg border border-slate-300 bg-white px-2 py-1 text-xs font-semibold text-slate-700 transition hover:border-sea hover:text-sea"
                >
                  一覧を更新
                </button>
              </div>
              <select id="providerModelSelect" class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-sea focus:outline-none"></select>
              <input
                id="providerModelManualInput"
                type="text"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-sea focus:outline-none"
                placeholder="モデルIDを直接入力"
              />
              <p id="modelFetchMessage" class="text-xs text-slate-500"></p>
              <p id="modelRequirementMessage" class="text-xs text-slate-600"></p>
            </div>

            <div id="referenceImageSection" class="mt-3 hidden space-y-2 rounded-2xl border border-emerald-200 bg-emerald-50/60 p-3">
              <div class="flex items-center justify-between gap-2">
                <p class="text-xs font-semibold uppercase tracking-[0.08em] text-emerald-700">参照画像 (i2i)</p>
                <button
                  id="clearReferenceImageButton"
                  type="button"
                  class="rounded-lg border border-emerald-300 bg-white px-2 py-1 text-xs font-semibold text-emerald-700 transition hover:border-emerald-500"
                >
                  クリア
                </button>
              </div>
              <div
                id="referenceDropzone"
                class="rounded-xl border border-dashed border-emerald-300 bg-white p-3 text-center text-xs text-emerald-700"
              >
                ドラッグ&ドロップ または
                <label for="referenceImageInput" class="cursor-pointer font-semibold underline">画像を選択</label>
                <input id="referenceImageInput" type="file" accept="image/*" class="hidden" />
              </div>
              <input
                id="referenceImageUrlInput"
                type="url"
                class="w-full rounded-lg border border-emerald-200 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none"
                placeholder="または参照画像URLを入力"
              />
              <div id="referenceImagePreviewWrap" class="hidden rounded-xl border border-emerald-200 bg-white p-2">
                <img id="referenceImagePreview" class="h-28 w-full rounded-lg object-cover" alt="Reference image preview" />
                <p id="referenceImageMeta" class="mt-2 text-xs text-slate-600"></p>
              </div>
              <p id="referenceImageValidationMessage" class="hidden rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-xs text-red-700"></p>
            </div>

            <div class="mt-4 space-y-4">
              <div>
                <label class="block text-sm font-semibold text-slate-700" for="modeSelect">プロンプトモード</label>
                <select id="modeSelect" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:border-sea focus:outline-none">
                  <option value="light">Light Mode</option>
                  <option value="advanced">Advanced Mode</option>
                </select>
                <p id="modeHint" class="mt-2 text-xs text-slate-500"></p>
              </div>

              <div>
                <label for="commonPromptInput" class="block text-sm font-semibold text-slate-700">共通プロンプト</label>
                <textarea
                  id="commonPromptInput"
                  rows="4"
                  class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:border-sea focus:outline-none"
                  placeholder="画風・色味・構図などの共通条件"
                ></textarea>
                <p id="templateValidationMessage" class="mt-2 hidden rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-xs text-red-700"></p>
              </div>

              <details class="group rounded-2xl border border-slate-200 bg-slate-50/70 p-3">
                <summary class="cursor-pointer list-none text-sm font-semibold text-slate-700">
                  API設定 (ローカル保存)
                </summary>
                <div class="mt-3 space-y-3">
                  <div>
                    <label class="block text-xs font-semibold text-slate-600" for="falApiKeyInput">fal.ai API Key</label>
                    <input id="falApiKeyInput" type="password" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-sea focus:outline-none" placeholder="FAL_KEY..." />
                  </div>
                  <div>
                    <label class="block text-xs font-semibold text-slate-600" for="googleApiKeyInput">Google API Key</label>
                    <input id="googleApiKeyInput" type="password" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-sea focus:outline-none" placeholder="AIza..." />
                  </div>
                  <div class="rounded-xl border border-amber-200 bg-amber-50/70 p-3">
                    <p class="text-xs font-semibold text-amber-800">Firefly 直接接続 (推奨: セッション運用)</p>
                    <p class="mt-1 text-xs text-amber-700">
                      Client ID と Access Token を手動入力すると、Proxyなしで直接実行できます。
                      Access Tokenは「設定を保存」しても永続化されません。
                    </p>
                    <div class="mt-3 space-y-3">
                      <div>
                        <label class="block text-xs font-semibold text-slate-600" for="fireflyClientIdInput">Firefly Client ID</label>
                        <input id="fireflyClientIdInput" type="text" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-sea focus:outline-none" placeholder="Adobe Client ID" />
                      </div>
                      <div>
                        <label class="block text-xs font-semibold text-slate-600" for="fireflyAccessTokenInput">Firefly Access Token (Session only)</label>
                        <input id="fireflyAccessTokenInput" type="password" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-sea focus:outline-none" placeholder="eyJ..." />
                      </div>
                      <div>
                        <label class="block text-xs font-semibold text-slate-600" for="fireflyApiBaseInput">Firefly API Base (任意)</label>
                        <input id="fireflyApiBaseInput" type="url" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-sea focus:outline-none" placeholder="https://firefly-api.adobe.io" />
                      </div>
                      <div>
                        <label class="block text-xs font-semibold text-slate-600" for="fireflyContentClassInput">Firefly Content Class (任意)</label>
                        <select id="fireflyContentClassInput" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-sea focus:outline-none">
                          <option value="photo">Photo (写真的な画像)</option>
                          <option value="art">Art (芸術的な画像)</option>
                        </select>
                        <p class="mt-1 text-xs text-slate-500">生成画像の特性を指定します。Photoは写真的、Artは芸術的な仕上がりになります。</p>
                      </div>
                    </div>
                  </div>
                </div>
              </details>
            </div>
          </article>

          <article class="rounded-3xl border border-white/60 bg-white/85 p-5 shadow-card backdrop-blur-md">
            <h2 class="font-heading text-lg font-bold text-slateBrand">一括入力</h2>
            <label class="mt-3 block text-sm font-semibold text-slate-700" for="promptBatchInput">1行ごとに1プロンプト</label>
            <textarea
              id="promptBatchInput"
              rows="10"
              class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:border-sea focus:outline-none"
              placeholder="夕暮れの東京の町並み、映画的な光&#10;手書きアニメ風の猫、柔らかい色調"
            ></textarea>
            <div class="mt-4">
              <button
                id="createCardsButton"
                type="button"
                class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-soft transition hover:border-sea hover:text-sea"
              >
                カードを作成
              </button>
            </div>
          </article>
        </aside>

        <section class="space-y-4">
          <div class="rounded-3xl border border-white/60 bg-white/85 p-4 shadow-card backdrop-blur-md">
            <div class="flex flex-wrap items-center gap-3">
              <button
                id="generateExistingButton"
                type="button"
                class="rounded-xl bg-slate-800 px-4 py-2 text-sm font-semibold text-white transition hover:bg-slate-900 disabled:cursor-not-allowed disabled:bg-slate-400"
              >
                カードを全て生成
              </button>
              <button
                id="regenerateFailedButton"
                type="button"
                class="rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-sea hover:text-sea disabled:cursor-not-allowed disabled:text-slate-400"
              >
                失敗カードを再生成
              </button>
              <button
                id="downloadAllButton"
                type="button"
                class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-emerald-700 disabled:cursor-not-allowed disabled:bg-slate-400"
              >
                全カードを一括DL
              </button>
            </div>
            <p class="mt-2 text-xs text-slate-500">右側から一括実行・一括DLできます。PNGは可能な場合のみプロンプトMetadataを埋め込みます。</p>
          </div>

          <div class="rounded-3xl border border-white/60 bg-white/85 p-4 shadow-card backdrop-blur-md">
            <div class="flex flex-wrap items-center gap-3">
              <span class="rounded-full bg-slate-900 px-3 py-1 text-xs font-semibold text-white" id="statusSummary">Ready</span>
              <span class="text-xs text-slate-500" id="localOnlyIndicator">Storage: Browser IndexedDB only</span>
            </div>
            <p id="globalMessage" class="mt-3 hidden rounded-xl border px-3 py-2 text-sm"></p>
          </div>

          <div id="cardsGrid" class="grid gap-4 md:grid-cols-2 2xl:grid-cols-3"></div>
        </section>
      </section>
    </main>

    <template id="cardTemplate">
      <article class="card rounded-3xl border border-slate-200 bg-white p-4 shadow-soft transition">
        <div class="card-top relative overflow-hidden rounded-2xl bg-slate-100">
          <img class="card-image h-60 w-full object-cover" alt="Generated image" loading="lazy" />
          <div class="card-placeholder absolute inset-0 flex flex-col items-center justify-center gap-3 text-slate-500">
            <div class="loader hidden h-10 w-10 animate-spin rounded-full border-4 border-slate-300 border-t-sea"></div>
            <p class="placeholder-text text-sm font-semibold">生成待ち</p>
          </div>
        </div>

        <div class="mt-3">
          <div class="flex items-center justify-between gap-2">
            <p class="card-provider text-xs font-semibold uppercase tracking-[0.12em] text-slate-500"></p>
            <span class="card-status rounded-full px-2 py-1 text-xs font-semibold"></span>
          </div>

          <label class="mt-3 block text-xs font-semibold text-slate-500">プロンプト</label>
          <textarea class="card-prompt mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:border-sea focus:outline-none" rows="3"></textarea>

          <p class="card-error mt-2 hidden rounded-lg border border-coral/30 bg-coral/5 px-2 py-1 text-xs text-coral"></p>

          <div class="card-actions mt-3 flex items-center gap-2 opacity-100">
            <button type="button" class="card-regenerate inline-flex items-center justify-center rounded-lg bg-blue-600 px-3 py-2 text-xs font-semibold text-white transition hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">再生成</button>
            <button type="button" class="card-preview inline-flex items-center justify-center rounded-lg border border-blue-200 bg-white px-3 py-2 text-xs font-semibold text-blue-700 transition hover:border-blue-400 hover:text-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-300">プロンプトプレビュー</button>
            <button type="button" class="card-download inline-flex items-center justify-center rounded-lg bg-emerald-600 px-3 py-2 text-xs font-semibold text-white transition hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-400">DL</button>
            <button type="button" class="card-remove inline-flex items-center justify-center rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-600 transition hover:border-coral hover:text-coral">削除</button>
          </div>
        </div>
      </article>
    </template>

    <div id="previewModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/45 px-4">
      <div class="w-full max-w-3xl rounded-2xl border border-slate-200 bg-white p-4 shadow-card">
        <div class="flex items-center justify-between gap-3">
          <h3 class="font-heading text-lg font-bold text-slateBrand">プロンプトプレビュー</h3>
          <button
            id="closePreviewModalButton"
            type="button"
            class="rounded-lg border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-700 transition hover:border-slate-500"
          >
            閉じる
          </button>
        </div>
        <p id="previewModalHint" class="mt-2 text-xs text-slate-500"></p>
        <pre id="previewModalContent" class="mt-3 max-h-[60vh] overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs leading-6 text-slate-700"></pre>
        <div class="mt-3 flex items-center justify-end gap-2">
          <button
            id="copyPreviewButton"
            type="button"
            class="rounded-lg bg-slate-800 px-3 py-2 text-xs font-semibold text-white transition hover:bg-slate-900"
          >
            コピー
          </button>
        </div>
      </div>
    </div>

    <div id="imagePreviewModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/90 p-3">
      <div class="relative flex h-full w-full max-w-[1600px] items-center justify-center">
        <button
          id="closeImagePreviewModalButton"
          type="button"
          class="absolute right-2 top-2 z-10 rounded-lg border border-white/30 bg-slate-900/70 px-3 py-1 text-xs font-semibold text-white transition hover:border-white/60"
        >
          閉じる
        </button>
        <img
          id="imagePreviewModalImage"
          alt="Generated image full preview"
          class="max-h-full max-w-full rounded-xl object-contain shadow-card"
        />
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script type="module" src="./src/main.js?v=20260211l"></script>
  </body>
</html>
